<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Show All Menu Items</title>
    <meta name="author" content="Gourmacracy">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.2/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="stylesheets/style.css">
</head>
<body>
<div class="gourmacracy-main-container">
    <!-- restaurant header -->
    <div class="gourmacracy-menu-header-container">
        <div class="gourmacracy-menu-header-center">
            <img class="gourmacracy-menu-header-wrapper" src="images/gourmacracy-menu-banner.jpg" height="250">
            <a href="https://gourmacracy.herokuapp.com/menu.html?restaurantID=Epic+Eats"><img class="gourmacracy-epic-eats-pos gourmacracy-epic-eats-wrapper" src="images/epic-eats-logo.svg"></a>
        </div>
    </div>
    <!-- restaurant header -->
    <!-- epic eats info and menu output -->
    <div class="gourmacracy-menu-output-container">
        <div class="gourmacracy-menu-output-center">
            <h2>Epic Eats</h2>
            <p style="color: #808080">Seattle, WA&emsp;&#x2022;&emsp;American&emsp;&#x2022;&emsp;4.6&emsp;<i class="bi bi-star-fill"></i>&emsp;(6,500+ ratings)&emsp;&#x2022;&emsp;$$</p>
            <div class="jumbotron" style="width: 800px" id="output">Loading...</div>
        </div>
    </div>
    <!-- epic eats info and menu output -->
</div>
<!-- nav-bar -->
<div class="gourmacracy-nav-bar">
    <ul>
        <li style="float: left">
            <a href="index.html">
                <img src="images/gourmacracy-logo.svg" alt="logo" width="150">
            </a>
        </li>
        <li style="margin-top: 15px"><a href="logout.html"><i class="bi bi-box-arrow-right"></i>&emsp;Logout</a></li>
        <li style="margin-top: 15px"><a href="cart.html"><i class="bi bi-cart3"></i>&emsp;Cart</a></li>
    </ul>
</div>
<!-- nav-bar -->
<script>
    function CreateTable(data){
        let table = "";
        table =
            '<table class="table table-bordered table-hover"> \n' +
            '   <thead>\n' +
            '       <tr>\n' +
            '           <th scope="col">Item Name</th> \n'+
            '           <th scope="col">Category</th> \n'+
            '           <th scope="col">Description</th> \n'+
            '           <th scope="col">Price</th> \n'+
            '           <th scope="col">Rating&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th> \n'+
            '           <th scope="col">Actions</th> \n'+
            '       </tr>\n' +
            '   </thead>\n' +
            '   <tbody>\n';

        for (let menuItem in data){
            let average = Math.ceil((data[menuItem]["points"] / data[menuItem]["numRatings"]));
            table +=
                '       <tr>\n' +
                '           <td>' + data[menuItem]["itemName"]+  '</td>\n' +
                '           <td>' + data[menuItem]["category"]+  '</td>\n' +
                '           <td>' + data[menuItem]["description"]+  '</td>\n' +
                '           <td>$' + data[menuItem]["price"]+  '</td>\n' +
                '           <td>';
            for(let i =0; i < 5; i++) {
              if(average > 0) {
                table += '<i class="bi bi-star-fill"></i>';
                average--;
              } else {
                table += '<i class="bi bi-star"></i>';
              }
            }
            table += '</td>\n' +

                '           <td style=\"text-align:center\"> <button id=\"deleteButton\" class=\"btn btn-primary\" onclick=\"addMenuItemToCart(\''+ data[menuItem]["_id"] +
                '\')\">Add</button></td>\n' +
                '       </tr>\n';
        }

        table +=
            '   </tbody>\n' +
            '</table>\n'
        return table;
    }

    function CreateMenu(data) {
      let visibleMenu = "";
      let sortedMenu = [];
      let categoryExists = false;
      for(let menuItem in data) {
        //console.log(data[menuItem]["category"]);
        categoryExists = false;
        for(let i = 0; i < sortedMenu.length; i++) {
          //console.log(sortedMenu[i]);
          if(sortedMenu[i][0] == data[menuItem]["category"]) {
            sortedMenu[i].push(data[menuItem]);
            categoryExists = true;
          }
        }
        if(!categoryExists) {
          sortedMenu.push([data[menuItem]["category"]]);
          sortedMenu[sortedMenu.length-1].push(data[menuItem]);
        }
      }
      console.log(sortedMenu);

      for(let category in sortedMenu) {
        visibleMenu +=
            '<div class="row" id='+sortedMenu[category][0]+'>\n' +
            '   <br/><h4>'+sortedMenu[category][0]+'s</h4>\n';
        for(let menuItem in sortedMenu[category]) {
          if(sortedMenu[category][menuItem].itemName != null) {
            let average = Math.ceil((sortedMenu[category][menuItem].points / sortedMenu[category][menuItem].numRatings));
            visibleMenu +=
                '<div class="menu-item"> \n' +
                '   <p><b>'+sortedMenu[category][menuItem].itemName+
                '<span style="float: right;"> $'+sortedMenu[category][menuItem].price+'&emsp;&emsp;';
                for(let i =0; i < 5; i++) {
                  if(average > 0) {
                    visibleMenu += '<i class="bi bi-star-fill"></i>';
                    average--;
                  } else {
                    visibleMenu += '<i class="bi bi-star"></i>';
                  }
                }
            visibleMenu +=
                '   </span></b></p>\n' +
                '   <p>'+sortedMenu[category][menuItem].description+'</p>\n' +
                '   <p>';

            visibleMenu +=
                '   </p>\n' +
                '</div>\n';
          }
        }
        visibleMenu +=
            '</div><br/>\n';
      }

      return visibleMenu;
    }

    window.addEventListener('load', (event) =>{
        let url = "https://gourmacracy-customer-backend.herokuapp.com/api/menuItems/"
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function (){
            if (this.readyState == 4 && this.status == 200){
                document.getElementById("output").innerHTML =
                    CreateMenu(JSON.parse(this.responseText));
            }
        };
        xhttp.open('GET', url, true);
        xhttp.send();
    });

    function addMenuItemToCart(id) {
        let parameter = new URLSearchParams();
        parameter.append("menuItemID", id);
        location.href = "cart.html?" + parameter.toString();
        //code that sends to cart.....what happens next?


    }



</script>
</body>
</html>
