<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Checkout Form</title>
    <link rel="shortcut icon" type="image/x-icon" href="images/gfavicon.ico"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" type="text/css">
    <link rel="shortcut icon" type="image/x-icon" href="images/gfavicon.ico"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.2/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="stylesheets/checkout.css" type="text/css">
    <link rel="stylesheet" href="stylesheets/menu.css">
    <script type= "text/javascript" src = "js/countries.js"></script>
</head>
<body>
<div class="gourmacracy-main-container">
    <div class="gourmacracy-menu-container">
        <div class="row d-flex justify-content-center gourmacracy-menu-output-container">
            <div class="gourmacracy-checkout-output-center">
                <div class="col-md-8 col-xs-6">
                    <div class="col-8">
                        <h4>Billing Address</h4>
                        <form>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label" for="firstname">First Name</label>
                                    <input type="text" id="firstname" class="form-control">
                                </div>
                                <div class="col-6">
                                    <label class="form-label" for="lastname">Last name</label>
                                    <input type="text" id="lastname" class="form-control">
                                </div>

                                <div class="col-12">
                                    <label class="form-label" for="address">Address</label>
                                    <input type="text" id="address" class="form-control">
                                </div>
                                <div class="col-5">
                                    <label class="form-label" for="country">Country</label>
                                    <select class="form-select" onchange="print_state('state',this.selectedIndex)" id="country" name ="country">
                                    </select>
                                </div>
                                <div class="col-4">
                                    <label class="form-label" for="state">State</label>
                                    <select class="form-select" name ="state" id ="state">
                                        <option value="" selected="selected">Select State</option>
                                    </select>
                                </div>
                                <div class="col-3">
                                    <label class="form-label" for="zip">Zip Code</label>
                                    <input type="text" id="zip" class="form-control">
                                </div>
                            </div>
                            <hr>
                            <h4>Payment</h4>
                            <div class="form-check">
                                <input type="radio" class="form-check-input">
                                <label class="form-check-label">Credit Card</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" class="form-check-input">
                                <label class="form-check-label">Debit Card</label>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label" for="cardname">Name on Card</label>
                                    <input type="text" id="cardname" class="form-control">
                                    <small class="text-muted">Full name as displayed on card</small>
                                </div>
                                <div class="col-6">
                                    <label class="form-label" for="creditcard">Credit Card Number</label>
                                    <input type="text" id="creditcard" class="form-control">
                                </div>
                                <div class="col-3">
                                    <label class="form-label" for="expiration">Expiration</label>
                                    <input type="text" id="expiration" class="form-control" placeholder="MM/YYYY">
                                </div>
                                <div class="col-3">
                                    <label class="form-label" for="cvv">CVV</label>
                                    <input type="text" id="cvv" class="form-control">
                                </div>
                            </div>
                            <hr>
                            <!-- <button class="gourmacracy-button checkout-btn" onclick="validateForm()">Place Order</button> -->
                        </form>
                        <div class="card mb-4 mb-lg-0" style="margin-top: 15px;">
                            <div class="card-body">
                                <p><strong>We accept</strong></p>
                                <img class="me-2" width="45px"
                                     src="https://mdbcdn.b-cdn.net/wp-content/plugins/woocommerce-gateway-stripe/assets/images/visa.svg"
                                     alt="Visa" />
                                <img class="me-2" width="45px"
                                     src="https://mdbcdn.b-cdn.net/wp-content/plugins/woocommerce-gateway-stripe/assets/images/amex.svg"
                                     alt="American Express" />
                                <img class="me-2" width="45px"
                                     src="https://mdbcdn.b-cdn.net/wp-content/plugins/woocommerce-gateway-stripe/assets/images/mastercard.svg"
                                     alt="Mastercard" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- cart info -->
    <section class="gourmacracy-cart-container">
        <h4>Your items</h4>
<!--        <span class="badge bg-secondary rounded-pill" id="cartIndicator">0</span>-->
        <button class="gourmacracy-button checkout-btn" onclick="validateForm()">Place Order</button>
        <div class="cart-row" style="border-style: none; text-align: left;">
            <span class="cart-quantity cart-header cart-column" style="border-style: none"></span>
            <span class="cart-item cart-header cart-column" style="border-style: none"></span>
            <span class="cart-price cart-header cart-column" style="border-style: none; float: right"></span>
        </div>
        <hr>
        <div class="cart-items" style="border-style: none">
        </div><br><hr>
        <div class="cart-subtotal" style="text-align:left;">
            <span class="cart-subtotal-title">Subtotal</span>
            <span class="cart-subtotal-price" style="float:right;">$0</span>
        </div><br>
        <div class="cart-tax" style="text-align:left;">
            <span class="cart-tax-title">Tax (10.25%)</span>
            <span class="cart-tax-percentage" style="float:right;">$0</span>
        </div><br/>
        <div class="cart-tip" style="text-align:left;">
            <span class="cart-tip-title">Tip (15%)</span>
            <span class="cart-tip-percentage" style="float:right;">$0</span>
        </div><hr>
        <div class="cart-total" style="text-align:left;">
            <strong class="cart-total-title">Total</strong>
            <strong class="cart-total-price" style="float:right;">$0</strong>
        </div><br/>
    </section>
    <!-- cart info -->
</div>

<!-- nav-bar -->
<div class="gourmacracy-checkout-nav-bar">
    <a href="index.html" class="gourmacracy-logo-center">
        <img src="images/gourmacracy-logo.svg" alt="logo" width="150">
    </a>
    <ul>
        <li style="margin-top: 10px;"><a href="menu.html"><i class="bi bi-arrow-left"></i>&emsp;&emsp;Back to Store</a></li>
    </ul>
</div>
<!-- nav-bar -->

<script>

    print_country("country");

    window.addEventListener('load', (event) =>{
        let url = "https://gourmacracy-customer-backend.herokuapp.com/api/menuItems/"
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function (){
            if (this.readyState == 4 && this.status == 200){
                updateCartFromSession(JSON.parse(this.responseText));
            }
        };
        xhttp.open('GET', url, true);
        xhttp.send();
    });

    function is_creditCard(cc) {
        var reg = /^(?:(4[0-9]{12}(?:[0-9]{3})?)|(5[1-5][0-9]{14})|(6(?:011|5[0-9]{2})[0-9]{12})|(3[47][0-9]{13})|(3(?:0[0-5]|[68][0-9])[0-9]{11})|((?:2131|1800|35[0-9]{3})[0-9]{11}))$/;
        return reg.test(cc);
    }

    // tests for MM/YYYY
    function validateDate(date) {
        var reg = /^(0[1-9]|[1-9]|1[0-2])\/?([0-9]{4})$/;
        return reg.test(date);
    }

    function validateCVV(cvv){
        var reg = /^[0-9]{3,4}$/;
        return reg.test(cvv);
    }

    // Returns whether or not it has passed a date
    function notExpired(exp) {
        var curr = new Date();

        // mm/yyyy
        var dateParts = exp.split("/");
        var expDate = new Date(+dateParts[1], dateParts[0] - 1, "0");

        if ((expDate - curr) / (1000 * 3600 * 24) < 0) {
            return false;
        }
        return true;
    }

    // <form class="container-center" method="POST"
    //           action="https://gourmacracy-customer-backend.herokuapp.com/api/users" onsubmit="userFind(); return false">

    function validateForm() {

        let cardname = document.getElementById("cardname").value;
        let creditcard = document.getElementById("creditcard").value;
        let exp = document.getElementById("expiration").value;
        let cvv = document.getElementById("cvv").value;

        if (cardname === "") {
            alert("Name must be filled out");
        } else if (creditcard === "") {
            alert("Credit Card Information Required");
        } else if (exp === "") {
            alert("Must Provide an Expiration Date");
        } else if (cvv === "") {
            alert("CVV Number is Required");
        } else if (!validateDate(exp)) {
            alert("Invalid date format. The Date format requires is MM/YYYY");
        } else if (!validateCVV(cvv)) {
            alert("Invalid CVV.");
        } else if (!notExpired(exp)) {
            alert("The card is Expired!");
        } else if (!is_creditCard(creditcard)){
            alert("Invalid credit card number")
        } else {
            userModify();
        }
    }

    function addItemToCart(id, title, price, newItem) {
        var cartRow = document.createElement('div')
        cartRow.classList.add('cart-row')
        // cartRow.classList.add('list-group-item')
        cartRow.classList.add('d-flex')
        // cartRow.classList.add('justify-content-between')
        var cartItems = document.getElementsByClassName('cart-items')[0]
        var cartRowContents = `
                <div class="">
                  <div class="cart-item">
                      <div class="cart-quantity cart-column">
                      <span class="cart-quantity-input">1</span>
                       <span class="cart-item-title" style="font-weight: bold">${title}</span>
                       </div>
                  </div>
                  <div class="cart-column" style="text-align: left;">
                  <span class="cart-price">$${price}</span>
                  <span hidden class="hidden-id">${id}</span></div>
                </div>
                <hr>`
        /*
        <li class="list-group-item d-flex justify-content-between">
            <div>
                <h6><var>id</var></h6>
                <span class="text-muted"><var>id</var></span>
            </div>
            <span class="text-muted">Rs 500</span>
        </li>

        */
        cartRow.innerHTML = cartRowContents
        cartItems.append(cartRow)
        updateCartTotal();
    }

    function updateCartTotal() {
        var cartItemContainer = document.getElementsByClassName('cart-items')[0]
        var cartRows = cartItemContainer.getElementsByClassName('cart-row')
        var subtotal = 0
        var numItems = 0
        var taxRate = .1025
        // var tax = subtotal * taxRate
        var tipRate = .15
        // var tip = subtotal * tipRate
        for (var i = 0; i < cartRows.length; i++) {
            var cartRow = cartRows[i]
            var priceElement = cartRow.getElementsByClassName('cart-price')[0]
            var quantityElement = cartRow.getElementsByClassName('cart-quantity-input')[0]
            var price = parseFloat(priceElement.innerText.replace('$', ''))
            var quantity = parseInt(quantityElement.innerText)
            subtotal = subtotal + (price * quantity)
            var tax = subtotal * taxRate
            var tip = subtotal * tipRate
        }
        subtotal = Math.round(subtotal * 100) / 100
        document.getElementsByClassName('cart-subtotal-price')[0].innerText = '$' + subtotal
        document.getElementsByClassName('cart-tax-percentage')[0].innerText = '$' + Math.round(tax * 100) / 100
        document.getElementsByClassName('cart-tip-percentage')[0].innerHTML = '$' + Math.round(tip * 100) / 100
        total = subtotal + tax + tip
        document.getElementsByClassName('cart-total-price')[0].innerText = '$' + Math.round(total * 100) / 100
    }

    function updateCartFromSession(data) {
        // Update the cart from session data (localStorage)
        // Grab localStorage
        if(localStorage.getItem('cart') != null) {
            var cart = localStorage.getItem('cart').split(',');
            var alreadyAdded = [];

            // For length of localStorage, check each menu item against it.
            for(let i = 0; i < cart.length; i++) {
                for(let j = 0; j < data.length; j++) {

                    // If cart matches menuItem ID
                    if(cart[i] == data[j]["_id"]) {

                        let added = false;

                        // Check if menu item has been added before, mark if it has
                        for(let k = 0; k < alreadyAdded.length; k++) {
                            if(cart[i] == alreadyAdded[k]) {
                                added = true;
                                // Break out of for loop early if found
                                break;
                            }
                        }

                        // If it hasn't been added...
                        if(!added) {
                            // Add item to cart and alreadyAdded list.
                            addItemToCart(data[j]["_id"], data[j]["itemName"], data[j]["price"],false);
                            alreadyAdded.push(cart[i]);

                        } else {

                            // If it has not been added:
                            // find locations, check IDs and increase quantity.
                            var cartItemContainer = document.getElementsByClassName('cart-items')[0]
                            var cartRows = cartItemContainer.getElementsByClassName('cart-row')
                            for (var l = 0; l < cartRows.length; l++) {
                                var cartRow = cartRows[l]
                                var id = cartRow.getElementsByClassName('hidden-id')[0].innerText
                                var quantityElement = cartRow.getElementsByClassName('cart-quantity-input')[0].innerText
                                if(id == cart[i]) {
                                    cartRow.getElementsByClassName('cart-quantity-input')[0].innerText =
                                        (parseInt(cartRow.getElementsByClassName('cart-quantity-input')[0].innerText) + 1);
                                    // if the item has been found, break out early.
                                    break;
                                }
                            }

                        }
                        // Get out of for loop early to check next localStorage item if menu item found.
                        break;
                    }
                }
            }
            // Load items from local storage, apply to cartIndicator
            // if(localStorage.getItem('cart') != null) {
            //     var cart = localStorage.getItem('cart').split(',');
            //     if(cart[0] != "") {
            //         document.getElementById("cartIndicator").innerText = cart.length;
            //     } else {
            //         document.getElementById("cartIndicator").innerText = "0";
            //     }
            // }
        }
    }

    function userModify() {
        var userID = ""
        var cart = ""
        if(localStorage.getItem('id') != null) {
            userID = localStorage.getItem('id');
        }
        if(localStorage.getItem('cart') != null) {
            cart = localStorage.getItem('cart').split(',');
        }

        let url = "https://gourmacracy-customer-backend.herokuapp.com/api/users/purchase/";
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200){
                console.log("SUBMITTED");
                alert("Thank you for your purchase!");
                setTimeout(function(){
                    let parameter = new URLSearchParams();
                    location.href = "rate-order.html";
                },2000);
            }
        }
        let userData = "orders="  + cart  + "&";


        xhttp.open('PATCH', url + userID, true);
        // Just needed to place this line AFTER opening the object
        xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhttp.send(userData);
    }


    // const submitBtn = document.getElementsByClassName('checkout-btn');
    // const firstName = document.getElementById('firstname')
    // const lastName = document.getElementById('lastname')
    // const address = document.getElementById('address')
    // const country = document.getElementById ('country')
    // const state = document.getElementById('state')
    // const zipCode = document.getElementById('zip')
    // const formCheck = document.getElementsByClassName('form-check-input')
    // const cardName = document.getElementById('cardname')
    // const creditCard = document.getElementById('creditcard')
    // const expiration = document.getElementById('expiration')
    // const cvv = document.getElementById('cvv')
    //
    // function updateSubmitBtn(){
    //     const firstNameValue = firstName.value.trim();
    //     const lastNameValue = lastName.value.trim();
    //     const addressValue = address.value.trim();
    //     const countryValue = country.value.trim();
    //     const stateValue = state.value.trim();
    //     const zipCodeValue = zipCode.value.trim();
    //     const formCheckValue = formCheck.value.trim();
    //     const cardNameValue = cardName.value.trim();
    //     const creditCardValue = creditCard.value.trim();
    //     const expirationValue = expiration.value.trim();
    //     const cvvValue = cvv.value.trim();
    //
    //     debugger;
    //     if(firstNameValue && lastNameValue && addressValue && countryValue && stateValue && zipCodeValue
    //         && cardNameValue && creditCardValue && expirationValue && cvvValue){
    //         submitBtn.removeAttribute('disabled');
    //     }else {
    //         submitBtn.setAttribute('disabled', 'disabled');
    //     }
    // }
    //
    // firstName.addEventListener('change', updateSubmitBtn);
    // lastName.addEventListener('change', updateSubmitBtn);
    // address.addEventListener('change', updateSubmitBtn);
    // country.addEventListener('change', updateSubmitBtn);
    // state.addEventListener('change', updateSubmitBtn);
    // zipCode.addEventListener('change', updateSubmitBtn);
    // // formCheck.addEventListener('change', updateSubmitBtn);
    // cardName.addEventListener('change', updateSubmitBtn);
    // creditCard.addEventListener('change', updateSubmitBtn);
    // expiration.addEventListener('change', updateSubmitBtn);
    // cvv.addEventListener('change', updateSubmitBtn);

</script>
</body>
</html>
