<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Checkout Form</title>
        <link rel="shortcut icon" type="image/x-icon" href="images/gfavicon.ico"/>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" type="text/css">
        <link rel="stylesheet" href="stylesheets/style2.css" type="text/css">
        <script type= "text/javascript" src = "js/countries.js"></script>
    </head>
    <body>
        <div class="container checkout-container col-8 my-5 br-2 rounded">
            <div class="row g-3">
              <div class="col-4 order-md-last">
                    <h4 class="d-flex justify-content-between align-item-center">
                        <span class="text-muted">Your Cart</span>
                        <span class="badge bg-secondary rounded-pill" id="cartIndicator">0</span>
                    </h4>
                    <ul class="list-group">
                      <div class="cart-row">
                          <span class="cart-item cart-header cart-column"></span>
                          <span class="cart-price cart-header cart-column"></span>
                          <span class="cart-quantity cart-header cart-column"></span>
                      </div>
                      <hr>
                      <div class="cart-items">
                      </div><br/>
                      <div class="cart-subtotal">
                          <p class="cart-subtotal-title" style="text-align: center;"><strong>Subtotal: </strong><span class="cart-subtotal-price">$0</span></p>

                      </div><br/>
                    </ul>
                </div>
                <div class="col-8">
                    <h4>Billing Address</h4>
                    <form>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label" for="firstname">First Name</label>
                                <input type="text" id="firstname" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="form-label" for="lastname">Last name</label>
                                <input type="text" id="lastname" class="form-control">
                            </div>
                            <div class="col-12">
                                <label class="from-label" for="username">Username</label>
                                <div class="input-group">
                                    <span class="input-group-text">@</span>
                                    <input type="text" class="form-control" id="usrname">
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="email">Email
                                    <span class="text-muted">(Optional)</span>
                                </label>
                                <input type="text" id="email" class="form-control">
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="address">Address</label>
                                <input type="text" id="address" class="form-control">
                            </div>
                            <div class="col-5">
                                <label class="form-label" for="country">Country</label>
                                <select class="form-select" onchange="print_state('state',this.selectedIndex)" id="country" name ="country">
                                </select>
                            </div>
                            <div class="col-4">
                                <label class="form-label" for="state">State</label>
                                <select class="form-select" name ="state" id ="state">
                                    <option value="" selected="selected">Select State</option>
                                </select>
                            </div>
                            <div class="col-3">
                                <label class="form-label" for="zip">Zip</label>
                                <input type="text" id="zip" class="form-control">
                            </div>
                        </div>
                        <hr>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input">
                            <label class="form-check-label">Shipping address is the same as my billing address</label>
                        </div>
                        <hr>
                        <h4>Payment</h4>
                        <div class="form-check">
                            <input type="radio" class="form-check-input">
                            <label class="form-check-label">Credit Card</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input">
                            <label class="form-check-label">Debit Card</label>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label" for="cardname">Name on Card</label>
                                <input type="text" id="cardname" class="form-control">
                                <small class="text-muted">Full name as displayed on card</small>
                            </div>
                            <div class="col-6">
                                <label class="form-label" for="creditcard">Credit Card Number</label>
                                <input type="text" id="creditcard" class="form-control">
                            </div>
                            <div class="col-3">
                                <label class="form-label" for="expiration">Expiration</label>
                                <input type="text" id="expiration" class="form-control">
                            </div>
                            <div class="col-3">
                                <label class="form-label" for="cvv">CVV</label>
                                <input type="text" id="cvv" class="form-control">
                            </div>
                        </div>
                        <hr>
                        <button type="submit" class="btn btn-primary btn-block mb-4" onclick="validateForm()">Process Payment</button>
                    </form>
                </div>
            </div>
        </div>
        <script>

            print_country("country");

            window.addEventListener('load', (event) =>{
              let url = "https://gourmacracy-customer-backend.herokuapp.com/api/menuItems/"
              let xhttp = new XMLHttpRequest();
              xhttp.onreadystatechange = function (){
                  if (this.readyState == 4 && this.status == 200){
                      updateCartFromSession(JSON.parse(this.responseText));
                  }
              };
              xhttp.open('GET', url, true);
              xhttp.send();
            });

            function get () {
            // (A) GET FROM SESSION
            //var id = sessionStorage.getItem("id");

            // (B) IT WORKS!
            // MANUALLY OPENING 1B-SESSION.HTML WILL NOT WORK THOUGH
            // SESSION DATA WILL PERISH ONCE TAB/WINDOW IS CLOSED
            //console.log(first);  // Foo Bar
            //console.log(second); // ["Hello", "World"]

            // (EXTRA) CLEAR SESSION STORAGE
            // sessionStorage.removeItem("KEY");
            // sessionStorage.clear();
            }

            function is_creditCard(str)
            {
            regexp = /^(?:(4[0-9]{12}(?:[0-9]{3})?)|(5[1-5][0-9]{14})|(6(?:011|5[0-9]{2})[0-9]{12})|(3[47][0-9]{13})|(3(?:0[0-5]|[68][0-9])[0-9]{11})|((?:2131|1800|35[0-9]{3})[0-9]{11}))$/;

                    if (regexp.test(str))
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
            }

            // tests for MM/YYYY
            function validateDate(testdate) {
                var date_regex = /^(0[1-9]|[1-9]|1[0-2])\/?([0-9]{4})$/;
                return date_regex.test(testdate);
            }

            function validateCVV(sample){
                var re = new RegExp("\d\d\d");
                    if (re.test(sample)){
                        console.log("Valid CVV");
                    }else{
                        alert("Invalid CVV!");
                    }

            }

            // Returns whether or not it has passed a date
            function notExpired(exp) {
                var curr = new Date();

                // mm/yyyy
                var dateParts = exp.split("/");
                var expDate = new Date(+dateParts[1], dateParts[0] - 1, "0");

                if ((expDate - curr) / (1000 * 3600 * 24) < 0) {
                    return false;
                }
                return true;
            }

            // <form class="container-center" method="POST"
            //           action="https://gourmacracy-customer-backend.herokuapp.com/api/users" onsubmit="userFind(); return false">

            function validateForm() {
                    alert(localStorage.getItem('cart'));
                    let cardname = document.getElementById("cardname").value;
                    let creditcard = document.getElementById("creditcard").value;
                    let exp = document.getElementById("expiration").value;
                    let cvv = document.getElementById("cvv").value;

                    validateCVV(cvv);

                    if (cardname === "") {
                        alert("Name must be filled out");
                        return false;
                    } else if (creditcard === "") {
                        alert("Credit Card Information Required");
                        return false;
                    } else if (exp === "") {
                        alert("Must Provide an Expiration Date");
                        return false;
                    } else if (cvv === "") {
                        alert("CVV Number is Required");
                        return false;
                    }

                    if (!validateDate(exp)) {
                        alert("Invalid date format. The Date format requires is MM/YYYY");
                        return false;
                    }

                    if (!notExpired(exp)) {
                        alert("The Card is Expired!");
                        return false;
                    }

                    if (!is_creditCard(creditcard)){
                        alert("The Credit Card Number Is Not Valid!")

                        }if (!validateDate(exp)){
                            alert("The Date Format Required is MM/YY");

                        }else {

                        alert("Your Payment has been Received! Thank You!");

                        setTimeout(function(){
                        let parameter = new URLSearchParams();
                        location.href = "rate-order.html";
                    },3000);
                }
            }

            function addItemToCart(id, title, price, newItem) {
                var cartRow = document.createElement('div')
                cartRow.classList.add('cart-row')
                cartRow.classList.add('list-group-item')
                cartRow.classList.add('d-flex')
                // cartRow.classList.add('justify-content-between')
                var cartItems = document.getElementsByClassName('cart-items')[0]
                var cartRowContents = `
                <div class="justify-content-between">
                  <div class="cart-item">
                      <span class="cart-item-title" style="font-weight: bold">${title}</span>
                  </div>
                  <span class="cart-price cart-column" style="float: right;">$${price}</span>
                  <span hidden class="hidden-id">${id}</span>
                  <div class="cart-quantity cart-column">
                      <span class="badge bg-secondary rounded-pill cart-quantity-input">1</span>
                  </div>
                </div>
                <hr>`
                /*
                <li class="list-group-item d-flex justify-content-between">
                    <div>
                        <h6><var>id</var></h6>
                        <span class="text-muted"><var>id</var></span>
                    </div>
                    <span class="text-muted">Rs 500</span>
                </li>

                */
                cartRow.innerHTML = cartRowContents
                cartItems.append(cartRow)
                updateCartTotal();
            }

            function updateCartTotal() {
                var cartItemContainer = document.getElementsByClassName('cart-items')[0]
                var cartRows = cartItemContainer.getElementsByClassName('cart-row')
                var subtotal = 0
                var numItems = 0
                for (var i = 0; i < cartRows.length; i++) {
                    var cartRow = cartRows[i]
                    var priceElement = cartRow.getElementsByClassName('cart-price')[0]
                    var quantityElement = cartRow.getElementsByClassName('cart-quantity-input')[0]
                    var price = parseFloat(priceElement.innerText.replace('$', ''))
                    var quantity = parseInt(quantityElement.innerText)
                    subtotal = subtotal + (price * quantity)
                }
                subtotal = Math.round(subtotal * 100) / 100
                document.getElementsByClassName('cart-subtotal-price')[0].innerText = '$' + subtotal
            }

            function updateCartFromSession(data) {
              // Update the cart from session data (localStorage)
              // Grab localStorage
              if(localStorage.getItem('cart') != null) {
                var cart = localStorage.getItem('cart').split(',');
                var alreadyAdded = [];

                // For length of localStorage, check each menu item against it.
                for(let i = 0; i < cart.length; i++) {
                  for(let j = 0; j < data.length; j++) {

                    // If cart matches menuItem ID
                    if(cart[i] == data[j]["_id"]) {

                      let added = false;

                      // Check if menu item has been added before, mark if it has
                      for(let k = 0; k < alreadyAdded.length; k++) {
                        if(cart[i] == alreadyAdded[k]) {
                          added = true;
                          // Break out of for loop early if found
                          break;
                        }
                      }

                      // If it hasn't been added...
                      if(!added) {
                        // Add item to cart and alreadyAdded list.
                        addItemToCart(data[j]["_id"], data[j]["itemName"], data[j]["price"],false);
                        alreadyAdded.push(cart[i]);

                      } else {

                        // If it has not been added:
                        // find locations, check IDs and increase quantity.
                        var cartItemContainer = document.getElementsByClassName('cart-items')[0]
                        var cartRows = cartItemContainer.getElementsByClassName('cart-row')
                        for (var l = 0; l < cartRows.length; l++) {
                            var cartRow = cartRows[l]
                            var id = cartRow.getElementsByClassName('hidden-id')[0].innerText
                            var quantityElement = cartRow.getElementsByClassName('cart-quantity-input')[0].innerText
                            if(id == cart[i]) {
                              cartRow.getElementsByClassName('cart-quantity-input')[0].innerText =
                              (parseInt(cartRow.getElementsByClassName('cart-quantity-input')[0].innerText) + 1);
                              // if the item has been found, break out early.
                              break;
                            }
                        }

                      }
                      // Get out of for loop early to check next localStorage item if menu item found.
                      break;
                    }
                  }
                }
                // Load items from local storage, apply to cartIndicator
                if(localStorage.getItem('cart') != null) {
                  var cart = localStorage.getItem('cart').split(',');
                  if(cart[0] != "") {
                    document.getElementById("cartIndicator").innerText = cart.length;
                  } else {
                    document.getElementById("cartIndicator").innerText = "0";
                  }
                }
              }
            }

            function userModify() {
                if(localStorage.getItem('id') != null) {
            var userID = localStorage.getItem('id');
            }
            if(localStorage.getItem('cart') != null) {
                    var cart = localStorage.getItem('cart').split(',');}

                    let url = "https://gourmacracy-customer-backend.herokuapp.com/api/users/purchase/";
                    let xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200){
                            document.getElementById("message").innerHTML =
                                "Thank you for your purchase!";
                        }
                    }
                    let userData = "orders="  + cart  + "&";


                    xhttp.open('PATCH', url + userID, true);
                    // Just needed to place this line AFTER opening the object
                    xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    xhttp.send(userData);
                }


        </script>
    </body>
</html>
