<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Show All Menu Items</title>
    <meta name="author" content="Gourmacracy">
    <link rel="shortcut icon" type="image/x-icon" href="images/gfavicon.ico"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.2/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="stylesheets/style.css">
</head>
<body>
  <div class="row d-flex justify-content-center gourmacracy-past-orders-output-container">
      <div class="col-md-8">
        <h2 id="userName">Rate Your Order</h2>
        <div class="jumbotron" id="loadingSign"><h4>Loading...</h4></div>
        <div class="cart-items"></div>
        <br/><br/><button class="gourmacracy-button rate-order-button" type="button" onclick="submitReview()">Submit Review</button>
    </div>
</div>
<!-- nav-bar -->
<div class="gourmacracy-nav-bar">
    <ul>
        <li style="float: left">
            <a href="index.html">
                <img src="images/gourmacracy-logo.svg" alt="logo" width="150">
            </a>
        </li>
        <li style="margin-top: 15px"><a href="logout.html"><i class="bi bi-box-arrow-right"></i>&emsp;Logout</a></li>
        <li style="margin-top: 15px" id="cartIndicator"><a href="menu.html"><i class="bi bi-cart3"></i>&emsp;Cart (0)</a></li>
    </ul>
</div>
<!-- nav-bar -->
<script>



    function LoadUserData(menuItems){
      // user with order ID data
      let userID = "";

      if(localStorage.getItem('id') != null) {
        userID = localStorage.getItem('id');
      }

      let url = "https://gourmacracy-customer-backend.herokuapp.com/api/users/" + userID;
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function (){
          if (this.readyState == 4 && this.status == 200){
              let userData = JSON.parse(this.responseText);

              if(!userData[0] && (userData.orders[0])) {
                var orders = (userData.orders[0]).split(',  ');
                var userMenuData = new Array;
                for(orderID in orders) {
                  for(item in menuItems) {
                    if(menuItems[item]["_id"] == orders[orderID]) {
                      userMenuData.push(menuItems[item]);
                    }
                  }
                }
                document.getElementById("userName").innerHTML =
                    userData.name + "'s Past Orders";
              }

              document.getElementById("output").innerHTML =
                  CreatePastOrders(userMenuData);
          }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }


    function ratingChange(item) {
        let starId = (item.id).split(':');
        let numStars = parseInt(starId[0]);
        let ratingID = starId[1];
        if(numStars > 0 && numStars < 6) {
          document.getElementById("stars"+ratingID).value = numStars;
        }
        //console.log(document.getElementById("stars"+ratingID).value);

        for(var i = 1; i < 6; i++) {
          var tempId = document.getElementById(i+":"+ratingID);
          if(tempId != null) {
            if(i <= numStars) {
              if(tempId.className == "bi bi-star-fill star-unchecked") {
                tempId.className = "bi bi-star-fill star-checked";
              }
            } else {
              if(tempId.className == "bi bi-star-fill star-checked") {
                tempId.className = "bi bi-star-fill star-unchecked";
              }
            }
          }
        }
    }

    function submitReview() {
      // rebuild data from cart: no duplicate IDs
      var cartItemContainer = document.getElementsByClassName('cart-items')[0]
      var cartRows = cartItemContainer.getElementsByClassName('menu-item')

      for (var l = 0; l < cartRows.length; l++) {
          var cartRow = cartRows[l]
          var id = cartRow.getElementsByClassName('hidden-id')[0].innerText;
          var rating = cartRow.getElementsByClassName('hidden-rating')[0].value;
          var comment = cartRow.getElementsByClassName('hidden-comment')[0].value;

          if(rating > 0 && rating < 6) {
              // submit to rating with ID
              console.log(id +", "+ rating);
          }

          if(comment.length > 1) {
            // submit to comment with ID
            console.log(id +", "+ comment);
          }
      }


      // Add IDs with reviews.
      // Add IDs with comments.
      // Submit IDs with reviews and comments to database separately.
      alert("Review submitted!");
    }

    function addItemToCart(data, newItem) {
      //ratingsArray.push(data);
      let average = Math.ceil((data["points"] / data["numRatings"]));
      let strDataId = data["_id"];
      /*
      data[j]["_id"], data[j]["itemName"], data[j]["price"]
      */
        var cartRow = document.createElement('div')
        cartRow.classList.add('menu-item')
        // cartRow.classList.add('justify-content-between')
        var cartItems = document.getElementsByClassName('cart-items')[0]
        let visibleMenu = '';
            visibleMenu +=
            '<span hidden class="hidden-id">'+data["_id"]+'</span>\n' +
            '   <div class="cart-quantity cart-column">\n'+
            '      <p><b>'+data["itemName"]+
            '      <span style="float: right;"> $'+data["price"]+'&emsp;&emsp;' +
            '      </span>\n' +
            '      <span style="margin-left: 10px;" class="badge bg-secondary rounded-pill cart-quantity-input">1</span></b></p>\n' +
            '   </div>\n'+
            '<p>'+data["description"]+'</p>\n' +
            '<br/>\n'+
            '<input hidden class="hidden-rating" type="text" value="5" id="stars'+data["_id"]+'"></input>\n' +
            '<h5 style="text-align: center;"><i>Rate:</i>'+
            '  <i class="bi bi-star-fill star-checked" id="1:'+data["_id"]+'" onclick="ratingChange(this)"></i>'+
            ' <i class="bi bi-star-fill star-checked" id="2:'+data["_id"]+'" onclick="ratingChange(this)"></i>'+
            ' <i class="bi bi-star-fill star-checked" id="3:'+data["_id"]+'" onclick="ratingChange(this)"></i>'+
            ' <i class="bi bi-star-fill star-checked" id="4:'+data["_id"]+'" onclick="ratingChange(this)"></i>'+
            ' <i class="bi bi-star-fill star-checked" id="5:'+data["_id"]+'" onclick="ratingChange(this)"></i>'+
            '</h6>\n'+
            '<h5 style="text-align: center;">Comment:</h5>\n'+
            '<input type="text" id="comment'+data["_id"]+'" class="form-control hidden-comment"><br/>\n';

        cartRow.innerHTML = visibleMenu;
        cartItems.append(cartRow);
    }

    function updateCartFromSession(data) {
      // Update the cart from session data (localStorage)
      // Grab localStorage
      if(localStorage.getItem('cart') != null) {
        var cart = localStorage.getItem('cart').split(',');
        var alreadyAdded = [];

        // For length of localStorage, check each menu item against it.
        for(let i = 0; i < cart.length; i++) {
          for(let j = 0; j < data.length; j++) {

            // If cart matches menuItem ID
            if(cart[i] == data[j]["_id"]) {

              let added = false;

              // Check if menu item has been added before, mark if it has
              for(let k = 0; k < alreadyAdded.length; k++) {
                if(cart[i] == alreadyAdded[k]) {
                  added = true;
                  // Break out of for loop early if found
                  break;
                }
              }

              // If it hasn't been added...
              if(!added) {
                // Add item to cart and alreadyAdded list.
                addItemToCart(data[j],false);
                alreadyAdded.push(cart[i]);

              } else {

                // If it has not been added:
                // find locations, check IDs and increase quantity.
                var cartItemContainer = document.getElementsByClassName('cart-items')[0]
                var cartRows = cartItemContainer.getElementsByClassName('menu-item')
                for (var l = 0; l < cartRows.length; l++) {
                    var cartRow = cartRows[l]
                    var id = cartRow.getElementsByClassName('hidden-id')[0].innerText
                    var quantityElement = cartRow.getElementsByClassName('cart-quantity-input')[0].innerText
                    if(id == cart[i]) {
                      cartRow.getElementsByClassName('cart-quantity-input')[0].innerText =
                      (parseInt(cartRow.getElementsByClassName('cart-quantity-input')[0].innerText) + 1);
                      // if the item has been found, break out early.
                      break;
                    }
                }

              }
              // Get out of for loop early to check next localStorage item if menu item found.
              break;
            }
          }
        }
        // Load items from local storage, apply to cartIndicator
        if(localStorage.getItem('cart') != null) {
          var cart = localStorage.getItem('cart').split(',');
          if(cart[0] != "") {
            cartIndicator(cart.length);
          }
        }
      }
      // When done loading, get rid of loading sign.
      document.getElementById("loadingSign").innerHTML = '';
    }

    function cartIndicator(number) {
      if(number >= 0) {
        document.getElementById("cartIndicator").innerHTML = '<a href="menu.html"><i class="bi bi-cart3"></i>&emsp;Cart ('+number+')</a>';
      }

      // If loaded from localStorage
      if(number == -1 && localStorage.getItem('cart') != null) {
        var cart = localStorage.getItem('cart').split(',');
        // If cart has data:
        if(cart[0] != "") {
          document.getElementById("cartIndicator").innerHTML = '<a href="menu.html"><i class="bi bi-cart3"></i>&emsp;Cart ('+cart.length+')</a>';
        }
      }
    }

    window.addEventListener('load', (event) =>{
      let url = "https://gourmacracy-customer-backend.herokuapp.com/api/menuItems/"
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function (){
          if (this.readyState == 4 && this.status == 200){
              updateCartFromSession(JSON.parse(this.responseText));
          }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    });



</script>
</body>
</html>
